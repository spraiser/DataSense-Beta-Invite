<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Integration Testing - DataSense</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .test-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .test-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .test-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-pending { background: #f3f4f6; color: #6b7280; }
        .status-testing { background: #fef3c7; color: #92400e; }
        .status-success { background: #d1fae5; color: #065f46; }
        .status-failed { background: #fee2e2; color: #991b1b; }
        
        .test-steps {
            margin: 15px 0;
        }
        
        .test-step {
            padding: 8px 0;
            border-left: 3px solid #e5e7eb;
            padding-left: 15px;
            margin-left: 5px;
            color: #4b5563;
            font-size: 14px;
            position: relative;
        }
        
        .test-step.active {
            border-color: #667eea;
            color: #333;
            font-weight: 500;
        }
        
        .test-step.completed {
            border-color: #10b981;
            color: #065f46;
        }
        
        .test-step.failed {
            border-color: #ef4444;
            color: #991b1b;
        }
        
        .test-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .test-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .event-log {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .event-log h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .clear-log {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .clear-log:hover {
            background: #dc2626;
        }
        
        .log-container {
            background: #f9fafb;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .log-entry.error {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .log-entry.success {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .log-timestamp {
            color: #6b7280;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .log-message {
            flex: 1;
            color: #333;
            word-break: break-word;
        }
        
        .log-data {
            color: #4b5563;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .summary-item {
            text-align: center;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .summary-value {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        
        .summary-label {
            color: #6b7280;
            font-size: 14px;
        }
        
        .info-banner {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-icon {
            font-size: 20px;
        }
        
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Analytics Integration Testing</h1>
            <p>Comprehensive testing suite for exit intent popup and ROI calculator analytics</p>
        </div>
        
        <div class="info-banner">
            <span class="info-icon">‚ÑπÔ∏è</span>
            <div>
                <strong>Testing Mode Active:</strong> Open the browser Developer Console to see detailed event logs. 
                Events will be tracked but not sent to actual analytics endpoints in this test environment.
            </div>
        </div>
        
        <div class="test-grid">
            <!-- Exit Intent Events Tests -->
            <div class="test-card">
                <h3 class="test-title">
                    Exit Intent Events
                    <span class="status-badge status-pending" id="exit-intent-status">Pending</span>
                </h3>
                <div class="test-steps">
                    <div class="test-step" id="step-show">‚úì Trigger exit_intent_shown</div>
                    <div class="test-step" id="step-close">‚úì Trigger exit_intent_closed</div>
                    <div class="test-step" id="step-dismiss">‚úì Trigger exit_intent_dismissed</div>
                </div>
                <button class="test-button" id="test-exit-intent" onclick="testExitIntentEvents()">
                    Run Exit Intent Tests
                </button>
            </div>
            
            <!-- ROI Calculator Events Tests -->
            <div class="test-card">
                <h3 class="test-title">
                    ROI Calculator Events
                    <span class="status-badge status-pending" id="roi-calc-status">Pending</span>
                </h3>
                <div class="test-steps">
                    <div class="test-step" id="step-interaction">‚úì roi_calculator_interaction</div>
                    <div class="test-step" id="step-revenue">‚úì roi_calculator_revenue_input</div>
                    <div class="test-step" id="step-hours">‚úì roi_calculator_hours_input</div>
                    <div class="test-step" id="step-calculated">‚úì roi_calculated</div>
                </div>
                <button class="test-button" id="test-roi-calc" onclick="testROICalculatorEvents()">
                    Run ROI Calculator Tests
                </button>
            </div>
            
            <!-- Conversion Events Tests -->
            <div class="test-card">
                <h3 class="test-title">
                    Conversion Events
                    <span class="status-badge status-pending" id="conversion-status">Pending</span>
                </h3>
                <div class="test-steps">
                    <div class="test-step" id="step-cta">‚úì exit_intent_cta_clicked</div>
                    <div class="test-step" id="step-conversion">‚úì exit_intent_conversion</div>
                    <div class="test-step" id="step-attribution">‚úì Verify session attribution</div>
                </div>
                <button class="test-button" id="test-conversion" onclick="testConversionEvents()">
                    Run Conversion Tests
                </button>
            </div>
            
            <!-- Full Integration Test -->
            <div class="test-card">
                <h3 class="test-title">
                    Full Integration Test
                    <span class="status-badge status-pending" id="integration-status">Pending</span>
                </h3>
                <div class="test-steps">
                    <div class="test-step" id="step-full-1">‚úì Show exit popup</div>
                    <div class="test-step" id="step-full-2">‚úì Interact with calculator</div>
                    <div class="test-step" id="step-full-3">‚úì Click CTA button</div>
                    <div class="test-step" id="step-full-4">‚úì Verify all events fired</div>
                </div>
                <button class="test-button" id="test-integration" onclick="runFullIntegrationTest()">
                    Run Full Integration Test
                </button>
            </div>
        </div>
        
        <!-- Event Log -->
        <div class="event-log">
            <h2>
                üìù Event Log
                <button class="clear-log" onclick="clearEventLog()">Clear Log</button>
            </h2>
            <div class="log-container" id="event-log-container">
                <div class="log-entry">
                    <span class="log-timestamp">00:00:00</span>
                    <div>
                        <div class="log-message">Analytics testing initialized</div>
                        <div class="log-data">Ready to track events...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Summary -->
        <div class="summary-card">
            <h2>üìà Test Summary</h2>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-value" id="total-events">0</div>
                    <div class="summary-label">Total Events</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="tests-passed">0</div>
                    <div class="summary-label">Tests Passed</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="tests-failed">0</div>
                    <div class="summary-label">Tests Failed</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="coverage">0%</div>
                    <div class="summary-label">Coverage</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Inject main script to get analytics tracking -->
    <script src="script-professional.js"></script>
    
    <script>
        // Analytics Testing Framework
        let eventLog = [];
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0
        };
        
        // Expected events to track
        const expectedEvents = {
            exitIntent: ['exit_intent_shown', 'exit_intent_closed', 'exit_intent_dismissed'],
            roiCalculator: ['roi_calculator_interaction', 'roi_calculator_revenue_input', 'roi_calculator_hours_input', 'roi_calculated'],
            conversion: ['exit_intent_cta_clicked', 'exit_intent_conversion']
        };
        
        // Override the trackEvent function to capture events
        const originalTrackEvent = window.DataSenseTracking.trackEvent;
        window.DataSenseTracking.trackEvent = function(eventName, properties) {
            // Call original function
            originalTrackEvent.call(this, eventName, properties);
            
            // Log the event
            logEvent(eventName, properties);
            
            // Update test status if applicable
            updateTestStatus(eventName);
        };
        
        function logEvent(eventName, properties) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = {
                time: timestamp,
                event: eventName,
                properties: properties
            };
            
            eventLog.push(entry);
            
            // Add to visual log
            const logContainer = document.getElementById('event-log-container');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry success';
            logEntry.innerHTML = `
                <span class="log-timestamp">${timestamp}</span>
                <div>
                    <div class="log-message">‚úÖ Event: <strong>${eventName}</strong></div>
                    <div class="log-data">${JSON.stringify(properties, null, 2)}</div>
                </div>
            `;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Update summary
            document.getElementById('total-events').textContent = eventLog.length;
            
            console.log(`üìä Analytics Event Tracked:`, eventName, properties);
        }
        
        function updateTestStatus(eventName) {
            // Map events to test steps
            const stepMap = {
                'exit_intent_shown': 'step-show',
                'exit_intent_closed': 'step-close',
                'exit_intent_dismissed': 'step-dismiss',
                'roi_calculator_interaction': 'step-interaction',
                'roi_calculator_revenue_input': 'step-revenue',
                'roi_calculator_hours_input': 'step-hours',
                'roi_calculated': 'step-calculated',
                'exit_intent_cta_clicked': 'step-cta',
                'exit_intent_conversion': 'step-conversion'
            };
            
            if (stepMap[eventName]) {
                const step = document.getElementById(stepMap[eventName]);
                if (step) {
                    step.classList.add('completed');
                }
            }
        }
        
        function clearEventLog() {
            eventLog = [];
            const logContainer = document.getElementById('event-log-container');
            logContainer.innerHTML = `
                <div class="log-entry">
                    <span class="log-timestamp">${new Date().toLocaleTimeString()}</span>
                    <div>
                        <div class="log-message">Event log cleared</div>
                        <div class="log-data">Ready to track new events...</div>
                    </div>
                </div>
            `;
            document.getElementById('total-events').textContent = '0';
        }
        
        // Test Functions
        async function testExitIntentEvents() {
            const statusBadge = document.getElementById('exit-intent-status');
            statusBadge.className = 'status-badge status-testing';
            statusBadge.textContent = 'Testing';
            
            console.log('üß™ Starting Exit Intent Events Test...');
            
            // Reset exit intent state
            sessionStorage.removeItem('exitIntentShown');
            
            // Test 1: Trigger exit_intent_shown
            console.log('Test 1: Triggering exit popup...');
            const overlay = document.getElementById('exit-popup-overlay');
            if (overlay) {
                // Simulate showing the popup
                window.DataSenseTracking.trackEvent('exit_intent_shown', {
                    trigger_type: 'test_trigger',
                    page_depth: 50,
                    time_on_page: 30
                });
                
                await sleep(1000);
                
                // Test 2: Trigger exit_intent_closed
                console.log('Test 2: Simulating close button click...');
                window.DataSenseTracking.trackEvent('exit_intent_closed', {
                    close_method: 'close_button',
                    time_shown: 5000
                });
                
                await sleep(1000);
                
                // Test 3: Trigger exit_intent_dismissed
                console.log('Test 3: Simulating overlay click...');
                window.DataSenseTracking.trackEvent('exit_intent_dismissed', {
                    dismiss_method: 'overlay_click',
                    time_shown: 3000
                });
                
                statusBadge.className = 'status-badge status-success';
                statusBadge.textContent = 'Passed';
                testResults.passed++;
            } else {
                console.error('Exit popup overlay not found!');
                statusBadge.className = 'status-badge status-failed';
                statusBadge.textContent = 'Failed';
                testResults.failed++;
            }
            
            updateSummary();
        }
        
        async function testROICalculatorEvents() {
            const statusBadge = document.getElementById('roi-calc-status');
            statusBadge.className = 'status-badge status-testing';
            statusBadge.textContent = 'Testing';
            
            console.log('üß™ Starting ROI Calculator Events Test...');
            
            // Test calculator interactions
            console.log('Test 1: Simulating revenue input...');
            window.DataSenseTracking.trackEvent('roi_calculator_interaction', {
                field_changed: 'revenue',
                interaction_type: 'input'
            });
            window.DataSenseTracking.trackEvent('roi_calculator_revenue_input', {
                revenue_value: 75000
            });
            
            await sleep(1000);
            
            console.log('Test 2: Simulating hours input...');
            window.DataSenseTracking.trackEvent('roi_calculator_interaction', {
                field_changed: 'hours',
                interaction_type: 'input'
            });
            window.DataSenseTracking.trackEvent('roi_calculator_hours_input', {
                hours_value: 60
            });
            
            await sleep(1000);
            
            console.log('Test 3: Simulating ROI calculation...');
            window.DataSenseTracking.trackEvent('roi_calculated', {
                revenue_input: 75000,
                hours_input: 60,
                total_savings: 12000,
                time_savings: 52,
                monthly_roi: 450
            });
            
            statusBadge.className = 'status-badge status-success';
            statusBadge.textContent = 'Passed';
            testResults.passed++;
            
            updateSummary();
        }
        
        async function testConversionEvents() {
            const statusBadge = document.getElementById('conversion-status');
            statusBadge.className = 'status-badge status-testing';
            statusBadge.textContent = 'Testing';
            
            console.log('üß™ Starting Conversion Events Test...');
            
            // Test CTA click
            console.log('Test 1: Simulating CTA button click...');
            window.DataSenseTracking.trackEvent('exit_intent_cta_clicked', {
                button_text: 'Claim Your ROI Now',
                time_shown: 8000,
                roi_values: {
                    revenue: 75000,
                    hours: 60,
                    savings: '$12,000',
                    roi: '450%'
                }
            });
            
            await sleep(1000);
            
            // Test conversion tracking
            console.log('Test 2: Tracking conversion...');
            window.DataSenseTracking.trackEvent('exit_intent_conversion', {
                action: 'cta_click_to_signup',
                session_id: window.DataSenseTracking.sessionId
            });
            
            await sleep(1000);
            
            // Verify attribution
            console.log('Test 3: Verifying session attribution...');
            const hasSessionId = window.DataSenseTracking.sessionId !== undefined;
            
            if (hasSessionId) {
                document.getElementById('step-attribution').classList.add('completed');
                statusBadge.className = 'status-badge status-success';
                statusBadge.textContent = 'Passed';
                testResults.passed++;
            } else {
                document.getElementById('step-attribution').classList.add('failed');
                statusBadge.className = 'status-badge status-failed';
                statusBadge.textContent = 'Failed';
                testResults.failed++;
            }
            
            updateSummary();
        }
        
        async function runFullIntegrationTest() {
            const statusBadge = document.getElementById('integration-status');
            statusBadge.className = 'status-badge status-testing';
            statusBadge.textContent = 'Testing';
            
            console.log('üß™ Starting Full Integration Test...');
            
            // Clear previous events
            clearEventLog();
            
            // Step 1: Show exit popup
            console.log('Step 1: Showing exit popup...');
            document.getElementById('step-full-1').classList.add('active');
            window.DataSenseTracking.trackEvent('exit_intent_shown', {
                trigger_type: 'integration_test',
                page_depth: 75,
                time_on_page: 120
            });
            document.getElementById('step-full-1').classList.remove('active');
            document.getElementById('step-full-1').classList.add('completed');
            
            await sleep(1500);
            
            // Step 2: Interact with calculator
            console.log('Step 2: Interacting with calculator...');
            document.getElementById('step-full-2').classList.add('active');
            
            // Simulate multiple interactions
            window.DataSenseTracking.trackEvent('roi_calculator_interaction', {
                field_changed: 'revenue',
                interaction_type: 'input'
            });
            window.DataSenseTracking.trackEvent('roi_calculator_revenue_input', {
                revenue_value: 100000
            });
            
            await sleep(500);
            
            window.DataSenseTracking.trackEvent('roi_calculator_interaction', {
                field_changed: 'hours',
                interaction_type: 'input'
            });
            window.DataSenseTracking.trackEvent('roi_calculator_hours_input', {
                hours_value: 80
            });
            
            await sleep(500);
            
            window.DataSenseTracking.trackEvent('roi_calculated', {
                revenue_input: 100000,
                hours_input: 80,
                total_savings: 16000,
                time_savings: 70,
                monthly_roi: 520
            });
            
            document.getElementById('step-full-2').classList.remove('active');
            document.getElementById('step-full-2').classList.add('completed');
            
            await sleep(1500);
            
            // Step 3: Click CTA button
            console.log('Step 3: Clicking CTA button...');
            document.getElementById('step-full-3').classList.add('active');
            
            window.DataSenseTracking.trackEvent('exit_intent_cta_clicked', {
                button_text: 'Claim Your ROI Now',
                time_shown: 15000,
                roi_values: {
                    revenue: 100000,
                    hours: 80,
                    savings: '$16,000',
                    roi: '520%'
                }
            });
            
            window.DataSenseTracking.trackEvent('exit_intent_conversion', {
                action: 'cta_click_to_signup',
                session_id: window.DataSenseTracking.sessionId
            });
            
            document.getElementById('step-full-3').classList.remove('active');
            document.getElementById('step-full-3').classList.add('completed');
            
            await sleep(1500);
            
            // Step 4: Verify all events
            console.log('Step 4: Verifying all events...');
            document.getElementById('step-full-4').classList.add('active');
            
            const requiredEvents = [
                'exit_intent_shown',
                'roi_calculator_interaction',
                'roi_calculator_revenue_input',
                'roi_calculator_hours_input',
                'roi_calculated',
                'exit_intent_cta_clicked',
                'exit_intent_conversion'
            ];
            
            const trackedEventNames = eventLog.map(e => e.event);
            const allEventsTracked = requiredEvents.every(event => 
                trackedEventNames.includes(event)
            );
            
            if (allEventsTracked) {
                document.getElementById('step-full-4').classList.remove('active');
                document.getElementById('step-full-4').classList.add('completed');
                statusBadge.className = 'status-badge status-success';
                statusBadge.textContent = 'Passed';
                testResults.passed++;
                
                console.log('‚úÖ Full integration test passed! All events tracked correctly.');
            } else {
                document.getElementById('step-full-4').classList.remove('active');
                document.getElementById('step-full-4').classList.add('failed');
                statusBadge.className = 'status-badge status-failed';
                statusBadge.textContent = 'Failed';
                testResults.failed++;
                
                const missingEvents = requiredEvents.filter(event => 
                    !trackedEventNames.includes(event)
                );
                console.error('‚ùå Full integration test failed. Missing events:', missingEvents);
            }
            
            updateSummary();
        }
        
        function updateSummary() {
            document.getElementById('tests-passed').textContent = testResults.passed;
            document.getElementById('tests-failed').textContent = testResults.failed;
            
            const totalTests = 4; // Total number of test suites
            const coverage = Math.round((testResults.passed / totalTests) * 100);
            document.getElementById('coverage').textContent = coverage + '%';
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìä Analytics Testing Suite Initialized');
            console.log('Session ID:', window.DataSenseTracking?.sessionId);
            
            // Add keyboard shortcut for quick testing
            document.addEventListener('keydown', function(e) {
                if (e.key === 't' && e.ctrlKey) {
                    console.log('Running all tests...');
                    runAllTests();
                }
            });
        });
        
        async function runAllTests() {
            console.log('üöÄ Running all analytics tests...');
            await testExitIntentEvents();
            await sleep(2000);
            await testROICalculatorEvents();
            await sleep(2000);
            await testConversionEvents();
            await sleep(2000);
            await runFullIntegrationTest();
            console.log('‚úÖ All tests completed!');
        }
    </script>
</body>
</html>