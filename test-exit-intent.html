<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exit Intent Debug Test - Task 3</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            margin-top: 0;
            text-align: center;
        }
        
        .instructions {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .instructions h2 {
            margin-top: 0;
            color: #fbbf24;
        }
        
        .instructions ol {
            line-height: 1.8;
        }
        
        .console-output {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #333;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
            border-left: 2px solid transparent;
        }
        
        .log-entry.error {
            color: #ff6b6b;
            border-left-color: #ff6b6b;
        }
        
        .log-entry.warn {
            color: #ffd93d;
            border-left-color: #ffd93d;
        }
        
        .log-entry.info {
            color: #6bcf7f;
            border-left-color: #6bcf7f;
        }
        
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            font-size: 14px;
        }
        
        .mouse-position {
            background: #2563eb;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        .browser-info {
            background: #059669;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2563eb;
        }
        
        button.danger {
            background: #ef4444;
        }
        
        button.danger:hover {
            background: #dc2626;
        }
        
        /* Exit popup styles (matching production) */
        #exit-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 99999;
            animation: fadeIn 0.3s ease-out;
        }
        
        #exit-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            color: #333;
            animation: slideUp 0.4s ease-out;
        }
        
        #exit-popup h2 {
            margin-top: 0;
            color: #ef4444;
        }
        
        #exit-popup-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translate(-50%, -40%);
            }
            to { 
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
    </style>
</head>
<body>
    <div class="status-bar">
        <div class="browser-info">
            Browser: <span id="browser-name">detecting...</span> | 
            Protocol: <span id="protocol">detecting...</span>
        </div>
        <div class="mouse-position">
            Mouse Y: <span id="mouse-y">0</span> | 
            Near Edge: <span id="near-edge">NO</span>
        </div>
    </div>
    
    <div class="container" style="margin-top: 60px;">
        <h1>üê≠ Exit Intent Debug Test - Task 3</h1>
        
        <div class="instructions">
            <h2>üìã Test Instructions:</h2>
            <ol>
                <li>Open browser console (F12 or right-click ‚Üí Inspect ‚Üí Console)</li>
                <li>Move mouse to the very top edge of the browser window</li>
                <li>Move mouse completely out of the browser window at the top</li>
                <li>Check console for "Mouse leave detected" messages</li>
                <li>Verify clientY values (should be ‚â§ 0 when exiting at top)</li>
                <li>Test on Chrome, Firefox, and Safari</li>
            </ol>
            
            <h3>üéØ Expected Results:</h3>
            <ul>
                <li>Console logs mouse position when near top edge (Y ‚â§ 5px)</li>
                <li>Console logs "Mouse leave detected" when mouse exits window</li>
                <li>clientY shows negative or zero values when exiting at top</li>
                <li>Exit popup triggers when conditions are met</li>
                <li>Both mouseleave and mouseout events are captured as fallback</li>
            </ul>
        </div>
        
        <div class="controls">
            <button onclick="clearConsole()">Clear Console</button>
            <button onclick="resetSession()">Reset Session Storage</button>
            <button onclick="testExitPopup()" class="danger">Test Exit Popup</button>
            <button onclick="exportLogs()">Export Logs</button>
        </div>
        
        <h3>üìä Live Console Output:</h3>
        <div id="console" class="console-output">
            <div class="log-entry info">Console initialized. Move mouse to top edge to begin testing...</div>
        </div>
    </div>
    
    <!-- Exit Popup -->
    <div id="exit-popup-overlay">
        <div id="exit-popup">
            <button id="exit-popup-close">√ó</button>
            <h2>üéØ Exit Intent Triggered!</h2>
            <p>The exit intent popup was successfully triggered.</p>
            <p><strong>Debug Info:</strong></p>
            <ul id="popup-debug-info">
                <li>Trigger method: <span id="trigger-method">unknown</span></li>
                <li>Mouse Y position: <span id="trigger-y">unknown</span></li>
                <li>Timestamp: <span id="trigger-time">unknown</span></li>
            </ul>
        </div>
    </div>
    
    <!-- Include the main script -->
    <script src="script-professional.js"></script>
    
    <!-- Additional debug script -->
    <script>
        // Custom console logger
        const logContainer = document.getElementById('console');
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function addLogEntry(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            
            let messageText = message;
            if (typeof message === 'object') {
                messageText = JSON.stringify(message, null, 2);
            }
            
            entry.textContent = `[${timestamp}] ${messageText}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Override console methods to capture logs
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addLogEntry(args.join(' '), 'info');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addLogEntry(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            addLogEntry(args.join(' '), 'warn');
        };
        
        // Browser detection
        function detectBrowser() {
            const userAgent = navigator.userAgent;
            let browserName = 'Unknown';
            
            if (userAgent.indexOf('Firefox') > -1) {
                browserName = 'Firefox';
            } else if (userAgent.indexOf('Safari') > -1 && userAgent.indexOf('Chrome') === -1) {
                browserName = 'Safari';
            } else if (userAgent.indexOf('Chrome') > -1) {
                browserName = 'Chrome';
            } else if (userAgent.indexOf('Edge') > -1) {
                browserName = 'Edge';
            }
            
            document.getElementById('browser-name').textContent = browserName;
            document.getElementById('protocol').textContent = window.location.protocol;
            
            console.log(`Browser detected: ${browserName}, Protocol: ${window.location.protocol}`);
        }
        
        // Mouse position tracking
        document.addEventListener('mousemove', (e) => {
            document.getElementById('mouse-y').textContent = e.clientY;
            document.getElementById('near-edge').textContent = e.clientY <= 5 ? 'YES' : 'NO';
            document.getElementById('near-edge').style.color = e.clientY <= 5 ? '#fbbf24' : '#ffffff';
        });
        
        // Control functions
        function clearConsole() {
            logContainer.innerHTML = '<div class="log-entry info">Console cleared</div>';
        }
        
        function resetSession() {
            try {
                sessionStorage.clear();
                window.__exitIntentShown = false;
                console.log('Session storage and exit intent flag reset');
                location.reload();
            } catch (e) {
                console.error('Failed to reset session:', e);
            }
        }
        
        function testExitPopup() {
            const overlay = document.getElementById('exit-popup-overlay');
            if (overlay) {
                overlay.style.display = 'block';
                document.getElementById('trigger-method').textContent = 'Manual test';
                document.getElementById('trigger-y').textContent = 'N/A';
                document.getElementById('trigger-time').textContent = new Date().toLocaleString();
                console.log('Exit popup manually triggered for testing');
            } else {
                console.error('Exit popup overlay not found!');
            }
        }
        
        function exportLogs() {
            const logs = Array.from(logContainer.children).map(el => el.textContent).join('\n');
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `exit-intent-debug-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            console.log('Logs exported to file');
        }
        
        // Initialize DataSenseTracking stub if not present
        if (!window.DataSenseTracking) {
            window.DataSenseTracking = {
                trackEvent: function(eventName, data) {
                    console.log(`DataSenseTracking.trackEvent: ${eventName}`, data);
                }
            };
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            detectBrowser();
            console.log('Exit Intent Debug Test initialized');
            console.log('Move mouse to top edge of browser to test mouseleave event');
        });
        
        // Listen for exit popup show events
        const originalShowExitPopup = window.showExitPopup;
        if (originalShowExitPopup) {
            window.showExitPopup = function() {
                document.getElementById('trigger-method').textContent = 'Auto (mouseleave/mouseout)';
                document.getElementById('trigger-y').textContent = document.getElementById('mouse-y').textContent;
                document.getElementById('trigger-time').textContent = new Date().toLocaleString();
                return originalShowExitPopup.apply(this, arguments);
            };
        }
    </script>
</body>
</html>