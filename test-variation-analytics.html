<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variation Analytics Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button.secondary {
            background: #6c757d;
        }
        button.secondary:hover {
            background: #545b62;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        .variation-selector {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .variation-btn {
            margin: 5px;
        }
        .analytics-display {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        .analytics-display h3 {
            margin-top: 0;
            color: #495057;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .metric:last-child {
            border-bottom: none;
        }
        .metric-label {
            font-weight: 600;
            color: #495057;
        }
        .metric-value {
            color: #007bff;
        }
        .test-content {
            margin: 30px 0;
            padding: 20px;
            background: #fff;
            border: 2px dashed #dee2e6;
            border-radius: 5px;
        }
        .test-content h2 {
            data-content-id: hero_title;
        }
        .test-content p {
            data-content-id: hero_subtitle;
        }
        .cta-button {
            display: inline-block;
            padding: 12px 30px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        .cta-button:hover {
            background: #0056b3;
        }
        .test-form {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        .log-entry {
            padding: 5px;
            margin: 2px 0;
            background: white;
            border-left: 3px solid #007bff;
            font-family: monospace;
            font-size: 12px;
        }
        .spacer {
            height: 1500px;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            margin: 30px 0;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
        }
        .json-display {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Variation Analytics Testing Dashboard</h1>
        
        <div class="variation-selector">
            <h3>Select Variation to Test:</h3>
            <div id="variationButtons"></div>
        </div>
        
        <div class="controls">
            <button onclick="showCurrentAnalytics()">Show Current Analytics</button>
            <button onclick="showEngagementScore()" class="secondary">Get Engagement Score</button>
            <button onclick="showConversionRates()" class="secondary">Show Conversion Rates</button>
            <button onclick="exportAnalyticsJSON()" class="success">Export JSON</button>
            <button onclick="exportAnalyticsCSV()" class="success">Export CSV</button>
            <button onclick="clearAnalytics()" class="danger">Clear All Data</button>
        </div>
        
        <div class="test-content">
            <h2 data-content-id="hero_title">Default Hero Title</h2>
            <p data-content-id="hero_subtitle">Default Hero Subtitle</p>
            <a href="#" class="cta-button" data-track="cta" data-content-id="cta_primary">Start Free Trial</a>
            <a href="#" class="cta-button" data-track="cta" data-content-id="cta_secondary">Watch Demo</a>
        </div>
        
        <div class="test-form">
            <h3>Test Form Tracking</h3>
            <form id="testForm" onsubmit="handleFormSubmit(event)">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="company">Company:</label>
                    <input type="text" id="company" name="company" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone:</label>
                    <input type="tel" id="phone" name="phone">
                </div>
                <button type="submit" class="cta-button">Submit Form</button>
            </form>
        </div>
        
        <div class="spacer">
            <h3>Scroll down to test scroll depth tracking</h3>
            <p>This spacer helps test scroll tracking at 25%, 50%, 75%, and 100%</p>
        </div>
        
        <div class="analytics-display">
            <h3>Live Analytics Data:</h3>
            <div id="analyticsOutput"></div>
        </div>
        
        <div class="analytics-display">
            <h3>Event Log:</h3>
            <div id="eventLog"></div>
        </div>
    </div>
    
    <script src="content-injection.js"></script>
    <script src="variation-analytics.js"></script>
    <script>
        let eventLogEntries = [];
        const maxLogEntries = 50;
        
        async function initializeTest() {
            await contentInjection.loadVariations();
            const variations = contentInjection.getAllVariations();
            
            const buttonContainer = document.getElementById('variationButtons');
            if (variations) {
                Object.keys(variations).forEach(variationId => {
                    const btn = document.createElement('button');
                    btn.className = 'variation-btn';
                    btn.textContent = `${variations[variationId].name} (${variationId})`;
                    btn.onclick = () => applyVariation(variationId);
                    buttonContainer.appendChild(btn);
                });
            }
            
            const originalTrackEvent = variationAnalytics.trackEvent;
            variationAnalytics.trackEvent = function(eventType, eventData) {
                originalTrackEvent.call(this, eventType, eventData);
                logEvent(eventType, eventData);
            };
            
            updateAnalyticsDisplay();
            setInterval(updateAnalyticsDisplay, 2000);
        }
        
        function applyVariation(variationId) {
            contentInjection.applyVariation(variationId);
            logEvent('Variation Applied', { variation_id: variationId });
            updateAnalyticsDisplay();
        }
        
        function showCurrentAnalytics() {
            const data = window.VariationAnalytics.getAnalyticsData();
            displayJSON(data);
        }
        
        function showEngagementScore() {
            const score = window.VariationAnalytics.getEngagementScore();
            alert(`Current Engagement Score: ${score}/100`);
            logEvent('Engagement Score Requested', { score });
        }
        
        function showConversionRates() {
            const rates = window.VariationAnalytics.getConversionRates();
            displayJSON(rates);
        }
        
        function exportAnalyticsJSON() {
            window.VariationAnalytics.downloadReport('json');
            logEvent('Analytics Exported', { format: 'json' });
        }
        
        function exportAnalyticsCSV() {
            window.VariationAnalytics.downloadReport('csv');
            logEvent('Analytics Exported', { format: 'csv' });
        }
        
        function clearAnalytics() {
            if (confirm('Are you sure you want to clear all analytics data?')) {
                window.VariationAnalytics.clearData();
                logEvent('Analytics Cleared', {});
                updateAnalyticsDisplay();
            }
        }
        
        function handleFormSubmit(event) {
            event.preventDefault();
            logEvent('Form Submitted', { 
                form_id: 'testForm',
                fields: ['email', 'company', 'phone']
            });
            alert('Form submitted! Check the analytics data.');
            event.target.reset();
        }
        
        function updateAnalyticsDisplay() {
            const output = document.getElementById('analyticsOutput');
            const data = window.VariationAnalytics.getAnalyticsData();
            const currentVariation = window.VariationAnalytics.getCurrentVariation();
            const engagementScore = window.VariationAnalytics.getEngagementScore();
            
            const metrics = [
                { label: 'Current Variation', value: currentVariation || 'None' },
                { label: 'Total Sessions', value: data.sessions.length },
                { label: 'Total Conversions', value: data.conversions.length },
                { label: 'Engagement Score', value: engagementScore + '/100' },
                { label: 'Sessions This Variation', value: data.sessions.filter(s => s.currentVariation === currentVariation).length },
                { label: 'Last Updated', value: new Date().toLocaleTimeString() }
            ];
            
            output.innerHTML = metrics.map(m => `
                <div class="metric">
                    <span class="metric-label">${m.label}:</span>
                    <span class="metric-value">${m.value}</span>
                </div>
            `).join('');
        }
        
        function logEvent(eventType, eventData) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = {
                time: timestamp,
                type: eventType,
                data: eventData
            };
            
            eventLogEntries.unshift(entry);
            if (eventLogEntries.length > maxLogEntries) {
                eventLogEntries = eventLogEntries.slice(0, maxLogEntries);
            }
            
            updateEventLog();
        }
        
        function updateEventLog() {
            const logContainer = document.getElementById('eventLog');
            logContainer.innerHTML = eventLogEntries.map(entry => `
                <div class="log-entry">
                    [${entry.time}] <strong>${entry.type}</strong>: ${JSON.stringify(entry.data).substring(0, 100)}...
                </div>
            `).join('');
        }
        
        function displayJSON(data) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                max-width: 80%;
                max-height: 80%;
                overflow: auto;
                z-index: 1000;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.onclick = () => {
                document.body.removeChild(modal);
                document.body.removeChild(overlay);
            };
            
            const jsonDisplay = document.createElement('div');
            jsonDisplay.className = 'json-display';
            jsonDisplay.textContent = JSON.stringify(data, null, 2);
            
            modal.appendChild(closeBtn);
            modal.appendChild(jsonDisplay);
            
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            `;
            overlay.onclick = () => {
                document.body.removeChild(modal);
                document.body.removeChild(overlay);
            };
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
        }
        
        document.addEventListener('DOMContentLoaded', initializeTest);
    </script>
</body>
</html>